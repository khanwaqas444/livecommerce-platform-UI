<div class="reservations-page">
  <div class="header">
    <h2>Reservations</h2>
    <div class="search-box">
      <input type="text" placeholder="Search by customer name, phone, booking..." [(ngModel)]="searchTerm"
        (input)="search()" />
      <button class="calendar-btn" (click)="toggleCalendarView()">ðŸ“… Calendar View</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button *ngFor="let t of tabs" [class.active]="activeTab === t.key" (click)="selectTab(t.key)">
      {{ t.label }}
      <span *ngIf="t.count">{{ t.count }}</span>
    </button>
  </div>

  <!-- Filters -->
  <div class="filter-card">
    <div class="filters">
      <div class="filter">
        <label>Status</label>
        <select [(ngModel)]="filters.status">
          <option value="">All Status</option>
          <option value="Confirmed">Confirmed</option>
          <option value="Pending">Pending</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </div>

      <div class="filter">
        <label>Date Range</label>
        <select [(ngModel)]="filters.dateRange">
          <option value="">Custom Range</option>
          <option value="today">Today</option>
          <option value="tomorrow">Tomorrow</option>
          <option value="week">This Week</option>
        </select>
      </div>

      <div class="filter">
        <label>Product</label>
        <select [(ngModel)]="filters.product">
          <option value="">All Products</option>
          <option *ngFor="let p of productList" [value]="p">{{ p }}</option>
        </select>
      </div>

      <div class="filter">
        <label>Sort By</label>
        <select [(ngModel)]="filters.sortBy">
          <option value="newest">Date (Newest First)</option>
          <option value="oldest">Date (Oldest First)</option>
        </select>
      </div>
    </div>

    <div class="filter-buttons">
      <button class="apply-btn" (click)="applyFilters()">Apply Filters</button>
      <button class="clear-btn" (click)="clearFilters()">Clear All</button>
    </div>
  </div>

  <!-- Table Section -->
  <div class="table-card">
    <div class="table-header">
      <h3>{{ filteredReservations.length }} Reservations for {{ activeTab | titlecase }}</h3>
      <div class="table-actions">
        <span>{{ selectedCount }} selected</span>
        <button class="reminder-btn" (click)="sendReminders()">ðŸ“© Send Reminder</button>
        <button class="export-btn" (click)="export('csv')">ðŸ“¤ Export</button>
      </div>
    </div>

    <table *ngIf="filteredReservations.length > 0">
      <thead>
        <tr>
          <th><input type="checkbox" (change)="toggleSelectAll($event)" /></th>
          <th>Booking ID</th>
          <th>Customer</th>
          <th>Date & Time</th>
          <th>Product</th>
          <th>People</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let r of filteredReservations" (click)="viewReservation(r.bookingId)">
          <td><input type="checkbox" [(ngModel)]="r.selected" (change)="updateSelectedCount()"
              (click)="$event.stopPropagation()" /></td>
          <td>#{{ r.bookingId }}</td>
          <td>
            <div class="cust-info">
              <div class="avatar">{{ r.customerName?.[0] || '?' }}</div>
              <div>
                <strong>{{ r.customerName }}</strong><br />
                <small>ðŸ“ž {{ r.customerPhone }}</small>
              </div>
            </div>
          </td>
          <td>
            {{ (r.reservationDate || r.createdAt) | date:'MMM d, y' }} <br />
            <small>{{ r.startTime || '' }}  {{ r.endTime || '' }}</small>
          </td>
          <td>{{ r.productName }}</td>
          <td>{{ r.people }}</td>
          <td>
            <span class="status" [ngClass]="r.status?.toLowerCase()">{{ r.status || 'Unknown' }}</span>
          </td>
          <td class="actions">
            <button class="view-btn" (click)="viewReservation(r.bookingId); $event.stopPropagation()">View</button>

            <button class="confirm-btn" *ngIf="r.status?.toLowerCase() === 'pending'"
              (click)="updateStatus(r, 'Confirmed'); $event.stopPropagation()">
              âœ“ Confirm
            </button>


            <button class="cancel-btn" *ngIf="r.status !== 'Cancelled'"
              (click)="updateStatus(r, 'Cancelled'); $event.stopPropagation()">
              âœ•
            </button>

            <ng-container *ngIf="r.status?.toLowerCase() === 'confirmed'">
              <button (click)="callCustomer(r.customerPhone!)" *ngIf="r.customerPhone">ðŸ“ž Call</button>

              <button (click)="messageCustomer(r.customerPhone!)" *ngIf="r.customerPhone">ðŸ’¬ Message</button>
            </ng-container>

          </td>
        </tr>
      </tbody>
    </table>  

    <div *ngIf="filteredReservations.length === 0" class="no-data">No reservations found.</div>
  </div>
</div>